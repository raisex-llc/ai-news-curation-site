---
import { getCollection } from 'astro:content';
import ArticleCard from '../../../components/ArticleCard.astro';

// ğŸ” ãƒšãƒ¼ã‚¸ã‚µã‚¤ã‚ºã‚’ã“ã“ã«ã‚‚å®šç¾©ï¼ˆå¿…è¦ï¼‰
const PAGE_SIZE = 30;

// ğŸ” getStaticPaths é–¢æ•°ï¼šãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã¨ã‚½ãƒ¼ãƒˆç¨®åˆ¥ï¼ˆdate / sourceï¼‰ã§ãƒ«ãƒ¼ãƒˆã‚’ç”Ÿæˆ
export async function getStaticPaths() {
  const allPosts = await getCollection('posts');
  const sorts = ['date', 'source'];
  const paths = [];

  for (const sort of sorts) {
    const sorted = sort === 'source'
      ? [...allPosts].sort((a, b) => a.data.source.localeCompare(b.data.source))
      : [...allPosts].sort((a, b) => new Date(b.data.pubDate) - new Date(a.data.pubDate));

    const totalPages = Math.ceil(sorted.length / PAGE_SIZE);
    for (let i = 1; i <= totalPages; i++) {
      paths.push({ params: { sort, page: String(i) } });
    }
  }

  return {
    params: paths.map((p) => p.params),
    props: {}, // æ˜ç¤ºçš„ã«ç©ºã® props ã‚’è¿”ã™ã“ã¨ã§ã‚¨ãƒ©ãƒ¼å›é¿
  };
}

// ğŸ” Astro.params ã‚’ä½¿ã£ã¦ç¾åœ¨ã®ãƒšãƒ¼ã‚¸æƒ…å ±ã‚’å–å¾—
const { sort, page } = Astro.params;
const allPosts = await getCollection('posts');

const sortedPosts = sort === 'source'
  ? [...allPosts].sort((a, b) => a.data.source.localeCompare(b.data.source))
  : [...allPosts].sort((a, b) => new Date(b.data.pubDate) - new Date(a.data.pubDate));

const currentPage = Number(page);
const totalPages = Math.ceil(sortedPosts.length / PAGE_SIZE);
const startIndex = (currentPage - 1) * PAGE_SIZE;
const posts = sortedPosts.slice(startIndex, startIndex + PAGE_SIZE);
---

<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>AIãƒ‹ãƒ¥ãƒ¼ã‚¹ä¸€è¦§ï¼ˆ{sort}ï¼‰â€“ Page {page}</title>
  </head>
  <body class="bg-white text-black">
    <main class="max-w-5xl mx-auto px-4 py-8">
      <h1 class="text-3xl font-bold mb-6">AIãƒ‹ãƒ¥ãƒ¼ã‚¹ä¸€è¦§ï¼ˆ{sort}ï¼‰ - Page {page}</h1>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {posts.map(post => (
          <ArticleCard
            title={post.data.title}
            pubDate={post.data.pubDate}
            description={post.data.summary}
            media={post.data.source}
            thumbnail={post.data.thumbnail}
            url={post.data.url}
          />
        ))}
      </div>

      <div class="mt-8 flex justify-center gap-4">
        {currentPage > 1 && <a href={`/page/${sort}/${currentPage - 1}`} class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">â† å‰</a>}
        {currentPage < totalPages && <a href={`/page/${sort}/${currentPage + 1}`} class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">æ¬¡ â†’</a>}
      </div>
    </main>
  </body>
</html>