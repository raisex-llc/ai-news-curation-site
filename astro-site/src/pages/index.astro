---
// src/pages/index.astro
import Layout from "../layouts/Layout.astro";
import ArticleCard from "../components/ArticleCard.astro";
import { getCollection } from "astro:content";

const PAGE_SIZE = 30;
const currentPage = 1;
const sort = "date";

// âœ… ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
const q = Astro.url?.searchParams.get("q")?.toLowerCase() ?? "";
const media = Astro.url?.searchParams.get("media")?.toLowerCase() ?? "";

// âœ… å…¨è¨˜äº‹å–å¾—
const allPosts = await getCollection("posts");

// âœ… ãƒ•ã‚£ãƒ«ã‚¿å‡¦ç†ï¼ˆANDæ¡ä»¶ï¼‰
const filteredPosts = allPosts.filter(post => {
  const title = post.data.title?.toLowerCase() ?? "";
  const desc = post.data.description?.toLowerCase() ?? "";
  const body = post.body?.toLowerCase() ?? "";
  const source = post.data.source?.toLowerCase() ?? "";

  const matchQ = !q || title.includes(q) || desc.includes(q) || body.includes(q);
  const matchMedia = !media || source.includes(media);

  return matchQ && matchMedia;
});

// âœ… pubDate é™é †ã‚½ãƒ¼ãƒˆ
const sortedPosts = [...filteredPosts].sort(
  (a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
);

// âœ… å…¨ä»¶è¡¨ç¤ºï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å»ƒæ­¢æ§‹æˆï¼‰
const paginatedPosts = sortedPosts;
const totalPages = 1;
const hasResults = paginatedPosts.length > 0;
---

<!-- âœ… æ¤œç´¢ä¸­ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆçµæœã‚ã‚Šï¼ãªã—ã‚’ data å±æ€§ã§ä¼é”ï¼‰ -->
<div
  id="search-overlay"
  class="fixed inset-0 z-50 bg-white/80 backdrop-blur-sm hidden flex items-center justify-center text-xl font-bold text-red-600"
  data-has-results="{hasResults}"
>
  ğŸ” æ¤œç´¢ä¸­ã§ã™â€¦ å°‘ã€…ãŠå¾…ã¡ãã ã•ã„
</div>

<Layout currentPage={currentPage} totalPages={totalPages} sort={sort} q={q} media={media}>
  <!-- âœ… æŠ•ç¨¿ã‚«ãƒ¼ãƒ‰è¡¨ç¤º -->
  <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
    {paginatedPosts.map((post) => (
      <ArticleCard
        title={post.data.title}
        pubDate={post.data.pubDate}
        description={post.data.description}
        media={post.data.source}
        thumbnail={post.data.thumbnail}
        url={post.data.url}
      />
    ))}
  </div>
</Layout>

<!-- âœ… æ¤œç´¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤åˆ¶å¾¡ -->
<script>
  window.addEventListener("DOMContentLoaded", () => {
    const params = new URLSearchParams(window.location.search);
    const q = params.get("q")?.trim();
    const media = params.get("media")?.trim();
    const hasQuery = q || media;

    const overlay = document.getElementById("search-overlay");

    if (hasQuery && overlay) {
      overlay.classList.remove("hidden");

      const hasResults = overlay.dataset.hasResults === "true";

      if (hasResults) {
        // âœ… æ¤œç´¢çµæœãŒã‚ã‚Œã°å³éè¡¨ç¤º
        overlay.classList.add("hidden");
      } else {
        // âœ… çµæœãŒãªã„å ´åˆã¯10ç§’é–“è¡¨ç¤º
        setTimeout(() => {
          overlay.classList.add("hidden");
        }, 10000);
      }
    }

    // âœ… ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã«å³è¡¨ç¤º
    const forms = document.querySelectorAll("form");
    forms.forEach((form) => {
      form.addEventListener("submit", () => {
        if (overlay) overlay.classList.remove("hidden");
      });
    });
  });
</script>
